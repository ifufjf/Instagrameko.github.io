<!DOCTYPE html>
<html>
<head>
    <title>Photopea + Google Integration</title>
    <style>
        .container { display: flex; gap: 20px; padding: 20px; }
        .panel { flex: 1; border: 1px solid #ccc; padding: 15px; }
        textarea { width: 100%; height: 150px; margin: 10px 0; }
        .spreadsheet-form { margin-top: 20px; }
        .form-row { margin: 10px 0; }
    </style>
</head>
<body>
    <div class="container">
        <!-- Sección Photopea -->
        <div class="panel">
            <h3>Photopea Editor</h3>
            <iframe id="photopea" style="width:100%; height:500px"></iframe>
            
            <div>
                <button onclick="executeCustomScript()">Ejecutar Script</button>
                <button onclick="savePSD()">Exportar PSD</button>
            </div>
            
            <textarea id="scriptEditor">
// Ejemplo: Mover capa activa
app.activeDocument.activeLayer.translate(20, 20);
            </textarea>
        </div>

        <!-- Sección Google Integration -->
        <div class="panel">
            <h3>Google Sheets Database</h3>
            <div class="spreadsheet-form">
                <div class="form-row">
                    <input type="text" id="layerName" placeholder="Nombre de capa">
                </div>
                <div class="form-row">
                    <input type="number" id="xPosition" placeholder="Posición X">
                </div>
                <div class="form-row">
                    <input type="number" id="yPosition" placeholder="Posición Y">
                </div>
                <button onclick="saveToGoogleSheet()">Guardar en Sheet</button>
                <button onclick="loadFromGoogleSheet()">Cargar Datos</button>
            </div>
            
            <div id="sheetData" style="margin-top:20px"></div>
        </div>
    </div>

    <script>
        // Configuración inicial
        const PHOTOPEA_PSD_URL = 'https://cors-anywhere.herokuapp.com/https://drive.google.com/uc?export=download&id=1GDay_9zypirLHFJKE1DJBn9aLDQrNCAP';
        const GOOGLE_SHEET_ID = 'TU_SHEET_ID';
        const GOOGLE_SCRIPT_URL = 'TU_SCRIPT_URL';

        // Photopea API Setup
        const photopea = document.getElementById('photopea');
        photopea.src = "https://www.photopea.com?api=1";
        let ppApi;

        window.addEventListener('message', async (e) => {
            if (e.source === photopea.contentWindow && e.data.type === 'apiReady') {
                ppApi = e.source;
                loadPSD();
            }
        });

        async function loadPSD() {
            try {
                const response = await fetch(PHOTOPEA_PSD_URL);
                const buffer = await response.arrayBuffer();
                
                ppApi.postMessage({
                    type: 'open',
                    data: new Uint8Array(buffer),
                    filename: 'design.psd'
                }, '*');
                
            } catch (error) {
                console.error('Error loading PSD:', error);
            }
        }

        function executeCustomScript() {
            const script = document.getElementById('scriptEditor').value;
            ppApi.postMessage({
                type: 'script',
                code: `try { ${script} } catch(e) { alert(e); }`
            }, '*');
        }

        function savePSD() {
            ppApi.postMessage({
                type: 'saveAsPSD',
                document: { id: 1 }
            }, '*');
        }

        // Google Sheets Integration
        async function loadFromGoogleSheet() {
            try {
                const response = await fetch(
                    `https://docs.google.com/spreadsheets/d/${GOOGLE_SHEET_ID}/gviz/tq?tqx=out:csv`
                );
                const data = await response.text();
                document.getElementById('sheetData').innerHTML = 
                    `<pre>${data}</pre>`;
                
            } catch (error) {
                console.error('Error loading sheet:', error);
            }
        }

        async function saveToGoogleSheet() {
            const payload = {
                layer: document.getElementById('layerName').value,
                x: document.getElementById('xPosition').value,
                y: document.getElementById('yPosition').value
            };

            try {
                await fetch(GOOGLE_SCRIPT_URL, {
                    method: 'POST',
                    body: JSON.stringify(payload)
                });
                alert('Datos guardados!');
            } catch (error) {
                console.error('Error saving data:', error);
            }
        }
    </script>
</body>
</html>
